import graphviz
from PIL import Image
import io

def generate_diagram(data):
    # Create a new directed graph
    dot = graphviz.Digraph(comment='Coastal Dune Ecosystem Food Chain')
    dot.attr(rankdir='TB', size='12,12', dpi='300', bgcolor='lightblue1')

    # Add nodes
    dot.attr('node', shape='box', style='filled', color='lightblue2', fontname='Arial', fontsize='14')
    for organism in data['organisms']:
        dot.node(organism, organism)

    # Add sun as energy source
    dot.attr('node', shape='circle', style='filled', color='yellow', fontname='Arial', fontsize='16')
    dot.node('Sun', 'Sun')

    # Add decomposers
    dot.attr('node', shape='hexagon', style='filled', color='brown1', fontname='Arial', fontsize='14')
    dot.node('Decomposers', 'Bacteria and Fungi')

    # Add edges
    dot.attr('edge', color='darkgreen', fontname='Arial', fontsize='12')
    for relationship in data['relationships']:
        if 'predator' in relationship:
            dot.edge(relationship['prey'], relationship['predator'], label='eaten by')
        elif 'consumer' in relationship:
            dot.edge(relationship['food'], relationship['consumer'], label='consumed by')

    # Connect sun to plants
    dot.attr('edge', color='orange', style='dashed')
    dot.edge('Sun', 'Dune Grasses', label='energy')
    dot.edge('Sun', 'Beach Pea', label='energy')
    dot.edge('Sun', 'Great Lakes Sand Cherry', label='energy')

    # Connect decomposers
    dot.attr('edge', color='brown', style='dotted')
    for organism in data['organisms']:
        dot.edge(organism, 'Decomposers', label='decomposed by')

    # Render the graph
    img_data = dot.pipe(format='png')
    img = Image.open(io.BytesIO(img_data))
    
    return img