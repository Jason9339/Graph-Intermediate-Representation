<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IR Viewer</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --panel: #ffffff;
      --accent: #0ea5e9;
      --text: #0f172a;
      --muted: #6b7280;
      --border: #e5e7eb;
      --code: #f3f4f6;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, #e0f2fe, #f5f7fb 50%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(90deg, rgba(56,189,248,0.08), rgba(56,189,248,0) 60%);
    }
    h1 { margin: 0; font-size: 20px; letter-spacing: 0.02em; }
    .subtle { color: var(--muted); font-size: 13px; margin-top: 6px; }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 12px;
      align-items: center;
    }
    .controls select,
    .controls button {
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 13px;
    }
    .controls button {
      cursor: pointer;
      border-color: var(--accent);
      color: var(--accent);
    }
    .controls .spacer {
      flex: 1;
    }
    main {
      flex: 1;
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 14px;
      padding: 12px;
      min-height: 0;
      overflow: hidden; /* keep independent scrollbars inside panels */
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .panel h2 {
      margin: 0 0 8px;
      font-size: 14px;
      letter-spacing: 0.02em;
      color: var(--accent);
    }
    .viewer {
      flex: 1;
      min-height: 0;
      overflow: auto;
      border: 1px dashed var(--border);
      border-radius: 8px;
      padding: 8px;
      background: #f9fafb;
    }
    .status-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    #svgHost svg {
      width: 100%;
      height: auto;
    }
    #svgHost img {
      max-width: 100%;
      height: auto;
      display: block;
    }
    #svgHost {
      min-height: 0;
      width: 100%;
    }
    #svgHost {
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: "SFMono-Regular", Menlo, Consolas, monospace;
      background: var(--code);
      color: #0f172a;
      padding: 8px;
      border-radius: 6px;
    }
    ul { margin: 0 0 0 16px; padding: 0; }
    li { margin: 4px 0; color: var(--muted); font-size: 13px; }
    .status { font-size: 13px; color: var(--muted); margin-top: 6px; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: rgba(56,189,248,0.15); color: var(--accent); font-size: 12px; }
    @media (max-width: 960px) {
      main { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>IR Viewer · Unified JSON</h1>
    <div class="subtle">直接瀏覽 <code>output/</code> 內的範例：左圖、右 IR JSON，無需上傳。</div>
    <div class="controls">
      <label for="sampleSelect">選擇範例</label>
      <select id="sampleSelect"></select>
      <button id="prevSample">上一個</button>
      <button id="nextSample">下一個</button>
      <div class="spacer"></div>
      <span class="badge" id="summary">載入中…</span>
    </div>
  </header>
  <main>
    <section class="panel">
      <h2>Render (SVG / PNG)</h2>
      <div id="svgHost" class="viewer">範例圖載入中…</div>
    </section>
    <section class="panel">
      <h2>IR JSON</h2>
      <div class="viewer">
        <pre id="irPre">範例 IR 載入中…</pre>
      </div>
      <div class="status-row">
        <div class="status" id="status">載入範例中…</div>
      </div>
    </section>
  </main>
  <script>
    const irPre = document.getElementById('irPre');
    const svgHost = document.getElementById('svgHost');
    const statusEl = document.getElementById('status');
    const summary = document.getElementById('summary');
    const sampleSelect = document.getElementById('sampleSelect');
    const prevBtn = document.getElementById('prevSample');
    const nextBtn = document.getElementById('nextSample');
    const isFileProtocol = window.location.protocol === 'file:';

    const samples = [
      {
        id: 'mermaid_textbook_6_132',
        label: 'Mermaid · textbook_6-132',
        json: 'output/mermaid/MermaidDiagramPipeline_textbook_6-132.json',
        svg: 'output/mermaid/MermaidDiagramPipeline_textbook_6-132.svg'
      },
      {
        id: 'mermaid_tree_1_146',
        label: 'Mermaid · tree_1-146',
        json: 'output/mermaid/MermaidDiagramPipeline_tree_1-146.json',
        svg: 'output/mermaid/MermaidDiagramPipeline_tree_1-146.svg'
      },
      {
        id: 'mermaid_network_1_185',
        label: 'Mermaid · network_1-185',
        json: 'output/mermaid/MermaidDiagramPipeline_network_1-185.json',
        svg: 'output/mermaid/MermaidDiagramPipeline_network_1-185.svg'
      },
      {
        id: 'mermaid_directed_1_199',
        label: 'Mermaid · directed_1-199',
        json: 'output/mermaid/MermaidDiagramPipeline_directed_1-199.json',
        svg: 'output/mermaid/MermaidDiagramPipeline_directed_1-199.svg'
      },
      {
        id: 'tikz_math_0_4',
        label: 'TikZ · math_0-4',
        json: 'output/tikz/LaTeXDiagramPipeline_math_0-4.json',
        svg: 'output/tikz/LaTeXDiagramPipeline_math_0-4.svg'
      },
      {
        id: 'tikz_fsm_1_247',
        label: 'TikZ · fsm_1-247',
        json: 'output/tikz/LaTeXDiagramPipeline_fsm_1-247.json',
        svg: 'output/tikz/LaTeXDiagramPipeline_fsm_1-247.svg'
      },
      {
        id: 'tikz_flow_1_387',
        label: 'TikZ · flow_1-387',
        json: 'output/tikz/LaTeXDiagramPipeline_flow_1-387.json',
        svg: 'output/tikz/LaTeXDiagramPipeline_flow_1-387.svg'
      },
      {
        id: 'graphviz_process',
        label: 'Graphviz · process',
        json: 'output/graphviz/process.json',
        svg: 'output/graphviz/process.svg'
      },
      {
        id: 'graphviz_btree',
        label: 'Graphviz · btree',
        json: 'output/graphviz/btree.json',
        svg: 'output/graphviz/btree.svg'
      },
      {
        id: 'graphviz_cluster',
        label: 'Graphviz · cluster',
        json: 'output/graphviz/cluster.json',
        svg: 'output/graphviz/cluster.svg'
      },
      {
        id: 'graphviz_cluster_edge',
        label: 'Graphviz · cluster_edge',
        json: 'output/graphviz/cluster_edge.json',
        svg: 'output/graphviz/cluster_edge.svg'
      }
    ];

    let currentIndex = 0;

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function updateSummary(ir) {
      if (!ir || !ir.nodes) {
        summary.textContent = 'No file loaded';
        return;
      }
      const nodes = ir.nodes.length;
      const edges = (ir.edges || []).length;
      const groups = (ir.groups || []).length;
      summary.textContent = `${ir.title || 'Untitled'} · nodes ${nodes}, edges ${edges}, groups ${groups}`;
    }

    function displayIR(text) {
      try {
        const data = JSON.parse(text);
        irPre.textContent = JSON.stringify(data, null, 2);
        updateSummary(data);
        setStatus('JSON loaded successfully.');
      } catch (err) {
        irPre.textContent = 'Failed to parse JSON: ' + err.message;
        setStatus('JSON parse error.');
        summary.textContent = 'Parse error';
      }
    }

    function displaySVG(text) {
      if (!text) {
        svgHost.textContent = 'No image loaded.';
        return;
      }
      svgHost.innerHTML = text;
      setStatus('SVG loaded.');
    }

    async function loadSample(index) {
      if (isFileProtocol) {
        const msg = '因瀏覽器限制，file:// 無法讀取本機檔案。請在專案根目錄執行 python3 -m http.server 8000，改用 http://localhost:8000 開啟。';
        setStatus(msg);
        irPre.textContent = msg;
        svgHost.textContent = msg;
        return;
      }
      const sample = samples[index];
      if (!sample) return;
      currentIndex = index;
      sampleSelect.value = sample.id;
      setStatus('Loading ' + sample.label + ' …');

      try {
        const [jsonRes, svgRes] = await Promise.all([
          fetch(sample.json),
          fetch(sample.svg)
        ]);
        if (!jsonRes.ok) throw new Error('JSON fetch failed: ' + jsonRes.status);
        if (!svgRes.ok) throw new Error('SVG fetch failed: ' + svgRes.status);

        const jsonText = await jsonRes.text();
        const svgText = await svgRes.text();

        displayIR(jsonText);
        displaySVG(svgText);
        summary.textContent = sample.label;
        setStatus('Loaded.');
      } catch (err) {
        irPre.textContent = 'Failed to load sample: ' + err.message;
        svgHost.textContent = 'Failed to load sample image.';
        summary.textContent = 'Load error';
        setStatus(err.message);
      }
    }

    function renderSampleOptions() {
      sampleSelect.innerHTML = '';
      samples.forEach((s) => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.label;
        sampleSelect.appendChild(opt);
      });
    }

    sampleSelect.addEventListener('change', () => {
      const idx = samples.findIndex((s) => s.id === sampleSelect.value);
      if (idx >= 0) loadSample(idx);
    });

    prevBtn.addEventListener('click', () => {
      const nextIndex = (currentIndex - 1 + samples.length) % samples.length;
      loadSample(nextIndex);
    });

    nextBtn.addEventListener('click', () => {
      const nextIndex = (currentIndex + 1) % samples.length;
      loadSample(nextIndex);
    });

    // Initialize
    renderSampleOptions();
    loadSample(0);
  </script>
</body>
</html>
