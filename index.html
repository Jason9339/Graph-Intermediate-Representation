<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IR Viewer</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --panel: #ffffff;
      --accent: #0ea5e9;
      --text: #0f172a;
      --muted: #6b7280;
      --border: #e5e7eb;
      --code: #f3f4f6;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, #e0f2fe, #f5f7fb 50%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(90deg, rgba(56,189,248,0.08), rgba(56,189,248,0) 60%);
    }
    h1 { margin: 0; font-size: 20px; letter-spacing: 0.02em; }
    .subtle { color: var(--muted); font-size: 13px; margin-top: 6px; }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 12px;
      align-items: center;
    }
    .controls select,
    .controls button {
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 13px;
    }
    .controls button {
      cursor: pointer;
      border-color: var(--accent);
      color: var(--accent);
    }
    .controls .spacer {
      flex: 1;
    }
    main {
      flex: 1;
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 14px;
      padding: 12px;
      min-height: 0;
      overflow: hidden; /* keep independent scrollbars inside panels */
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .panel h2 {
      margin: 0 0 8px;
      font-size: 14px;
      letter-spacing: 0.02em;
      color: var(--accent);
    }
    .viewer {
      flex: 1;
      min-height: 0;
      overflow: auto;
      border: 1px dashed var(--border);
      border-radius: 8px;
      padding: 8px;
      background: #f9fafb;
    }
    .status-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    #svgHost svg {
      width: 100%;
      height: auto;
    }
    #svgHost img {
      max-width: 100%;
      height: auto;
      display: block;
    }
    #svgHost {
      min-height: 0;
      width: 100%;
    }
    #svgHost {
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: "SFMono-Regular", Menlo, Consolas, monospace;
      background: var(--code);
      color: #0f172a;
      padding: 8px;
      border-radius: 6px;
    }
    ul { margin: 0 0 0 16px; padding: 0; }
    li { margin: 4px 0; color: var(--muted); font-size: 13px; }
    .status { font-size: 13px; color: var(--muted); margin-top: 6px; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: rgba(56,189,248,0.15); color: var(--accent); font-size: 12px; }
    @media (max-width: 960px) {
      main { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>IR Viewer · Unified JSON</h1>
    <div class="subtle">直接瀏覽 <code>output/</code> 內的範例：左圖、右 IR JSON，無需上傳。</div>
    <div class="controls">
      <label for="sampleSelect">選擇範例</label>
      <select id="sampleSelect"></select>
      <button id="prevSample">上一個</button>
      <button id="nextSample">下一個</button>
      <div class="spacer"></div>
      <span class="badge" id="summary">載入中…</span>
    </div>
  </header>
  <main>
    <section class="panel">
      <h2>Render (SVG / PNG)</h2>
      <div id="svgHost" class="viewer">範例圖載入中…</div>
    </section>
    <section class="panel">
      <h2>IR JSON</h2>
      <div class="viewer">
        <pre id="irPre">範例 IR 載入中…</pre>
      </div>
      <div class="status-row">
        <div class="status" id="status">載入範例中…</div>
      </div>
    </section>
  </main>
  <script>
    const irPre = document.getElementById('irPre');
    const svgHost = document.getElementById('svgHost');
    const statusEl = document.getElementById('status');
    const summary = document.getElementById('summary');
    const sampleSelect = document.getElementById('sampleSelect');
    const prevBtn = document.getElementById('prevSample');
    const nextBtn = document.getElementById('nextSample');
    const isFileProtocol = window.location.protocol === 'file:';

    const mermaidNames = [
      'MermaidDiagramPipeline_Block_1-46',
      'MermaidDiagramPipeline_Clinical_1-70',
      'MermaidDiagramPipeline_Clinical_2-101',
      'MermaidDiagramPipeline_Clinical_2-60',
      'MermaidDiagramPipeline_Clinical_2-78',
      'MermaidDiagramPipeline_Clinical_2-87',
      'MermaidDiagramPipeline_Concept_2-22',
      'MermaidDiagramPipeline_astronomy_2-79',
      'MermaidDiagramPipeline_bio_2-151',
      'MermaidDiagramPipeline_bio_2-175',
      'MermaidDiagramPipeline_bio_2-176',
      'MermaidDiagramPipeline_bottom_0-107',
      'MermaidDiagramPipeline_directed_1-199',
      'MermaidDiagramPipeline_familiy_1-18',
      'MermaidDiagramPipeline_food_1-52',
      'MermaidDiagramPipeline_food_2-111',
      'MermaidDiagramPipeline_function_1-112',
      'MermaidDiagramPipeline_function_2-76',
      'MermaidDiagramPipeline_instruction_1-104',
      'MermaidDiagramPipeline_instruction_2-116',
      'MermaidDiagramPipeline_mind_1-228',
      'MermaidDiagramPipeline_mind_2-234',
      'MermaidDiagramPipeline_ml_2-132',
      'MermaidDiagramPipeline_natural_2-191',
      'MermaidDiagramPipeline_natural_2-52',
      'MermaidDiagramPipeline_network_1-185',
      'MermaidDiagramPipeline_program_1-95',
      'MermaidDiagramPipeline_sequence_1-71',
      'MermaidDiagramPipeline_sequence_2-102',
      'MermaidDiagramPipeline_social_1-28',
      'MermaidDiagramPipeline_social_2-149',
      'MermaidDiagramPipeline_textbook_2-92',
      'MermaidDiagramPipeline_textbook_5-84',
      'MermaidDiagramPipeline_textbook_6-132',
      'MermaidDiagramPipeline_textbook_6-143',
      'MermaidDiagramPipeline_textbook_6-2',
      'MermaidDiagramPipeline_textbook_6-31',
      'MermaidDiagramPipeline_textbook_8-149',
      'MermaidDiagramPipeline_timeline_2-15',
      'MermaidDiagramPipeline_tree_1-146',
      'test_astronomy',
      'test_astronomy2',
      'test_astronomy3',
    ];

    const tikzNames = [
      'LaTeXDiagramPipeline_bio_1-54',
      'LaTeXDiagramPipeline_flow_1-103',
      'LaTeXDiagramPipeline_flow_1-173',
      'LaTeXDiagramPipeline_flow_1-272',
      'LaTeXDiagramPipeline_flow_1-387',
      'LaTeXDiagramPipeline_flow_1-430',
      'LaTeXDiagramPipeline_food_1-177',
      'LaTeXDiagramPipeline_food_1-82',
      'LaTeXDiagramPipeline_fsm_1-247',
      'LaTeXDiagramPipeline_fsm_1-329',
      'LaTeXDiagramPipeline_math_0-4',
      'LaTeXDiagramPipeline_mind_1-131',
      'LaTeXDiagramPipeline_mind_1-351',
      'LaTeXDiagramPipeline_ml_2-47',
      'LaTeXDiagramPipeline_natural_1-67',
      'LaTeXDiagramPipeline_textbook_2-18',
      'LaTeXDiagramPipeline_textbook_5-24',
    ];

    const graphvizNames = [
      'btree',
      'cluster',
      'cluster_edge',
      'colors',
      'er',
      'fdpclust',
      'fsm',
      'g_c_n',
      'hello',
      'process',
      'rank_same',
      'structs',
      'structs_revisited',
      'traffic_lights',
      'unix',
    ];

    const samples = [];
    mermaidNames.forEach((name) => {
      samples.push({
        id: `mermaid_${name}`,
        label: `Mermaid · ${name}`,
        json: `output/mermaid/${name}.json`,
        svg: `output/mermaid/${name}.svg`,
      });
    });
    tikzNames.forEach((name) => {
      samples.push({
        id: `tikz_${name}`,
        label: `TikZ · ${name}`,
        json: `output/tikz/${name}.json`,
        svg: `output/tikz/${name}.svg`,
      });
    });
    graphvizNames.forEach((name) => {
      samples.push({
        id: `graphviz_${name}`,
        label: `Graphviz · ${name}`,
        json: `output/graphviz/${name}.json`,
        svg: `output/graphviz/${name}.svg`,
      });
    });

    let currentIndex = 0;

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function updateSummary(ir) {
      if (!ir || !ir.nodes) {
        summary.textContent = 'No file loaded';
        return;
      }
      const nodes = ir.nodes.length;
      const edges = (ir.edges || []).length;
      const groups = (ir.groups || []).length;
      summary.textContent = `${ir.title || 'Untitled'} · nodes ${nodes}, edges ${edges}, groups ${groups}`;
    }

    function displayIR(text) {
      try {
        const data = JSON.parse(text);
        irPre.textContent = JSON.stringify(data, null, 2);
        updateSummary(data);
        setStatus('JSON loaded successfully.');
      } catch (err) {
        irPre.textContent = 'Failed to parse JSON: ' + err.message;
        setStatus('JSON parse error.');
        summary.textContent = 'Parse error';
      }
    }

    function displaySVG(text) {
      if (!text) {
        svgHost.textContent = 'No image loaded.';
        return;
      }
      svgHost.innerHTML = text;
      setStatus('SVG loaded.');
    }

    async function loadSample(index) {
      if (isFileProtocol) {
        const msg = '因瀏覽器限制，file:// 無法讀取本機檔案。請在專案根目錄執行 python3 -m http.server 8000，改用 http://localhost:8000 開啟。';
        setStatus(msg);
        irPre.textContent = msg;
        svgHost.textContent = msg;
        return;
      }
      const sample = samples[index];
      if (!sample) return;
      currentIndex = index;
      sampleSelect.value = sample.id;
      setStatus('Loading ' + sample.label + ' …');

      try {
        const [jsonRes, svgRes] = await Promise.all([
          fetch(sample.json),
          fetch(sample.svg)
        ]);
        if (!jsonRes.ok) throw new Error('JSON fetch failed: ' + jsonRes.status);
        if (!svgRes.ok) throw new Error('SVG fetch failed: ' + svgRes.status);

        const jsonText = await jsonRes.text();
        const svgText = await svgRes.text();

        displayIR(jsonText);
        displaySVG(svgText);
        summary.textContent = sample.label;
        setStatus('Loaded.');
      } catch (err) {
        irPre.textContent = 'Failed to load sample: ' + err.message;
        svgHost.textContent = 'Failed to load sample image.';
        summary.textContent = 'Load error';
        setStatus(err.message);
      }
    }

    function renderSampleOptions() {
      sampleSelect.innerHTML = '';
      samples.forEach((s) => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.label;
        sampleSelect.appendChild(opt);
      });
    }

    sampleSelect.addEventListener('change', () => {
      const idx = samples.findIndex((s) => s.id === sampleSelect.value);
      if (idx >= 0) loadSample(idx);
    });

    prevBtn.addEventListener('click', () => {
      const nextIndex = (currentIndex - 1 + samples.length) % samples.length;
      loadSample(nextIndex);
    });

    nextBtn.addEventListener('click', () => {
      const nextIndex = (currentIndex + 1) % samples.length;
      loadSample(nextIndex);
    });

    // Initialize
    renderSampleOptions();
    loadSample(0);
  </script>
</body>
</html>
